
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Vascular age - example &#8212; Signal Processing and Learning for Wearables</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Summary" href="../summary.html" />
    <link rel="prev" title="Vascular age - Intro" href="vasc-age-intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/icon.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Signal Processing and Learning for Wearables</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../overview.html">
   Overview
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../overview/workshop-2023-03.html">
     Workshop - March 2023
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../overview/workshop-2023-05.html">
     Workshop - May 2023
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../background.html">
   Background
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../background/wearables.html">
     Wearable Devices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../background/signals.html">
     Signals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../background/physiology.html">
     Physiology
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../background/applications.html">
     Applications
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../resources.html">
   Resources
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../resources/data.html">
     Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../resources/code.html">
     Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/data-exploration2.html">
     Exploring PTT-PPG
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/data-exploration.html">
     Exploring MIMIC-IV
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/data-exploration3.html">
     Exploring MIMIC-III
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/data-exploration4.html">
     Exploring OpenOx
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/signal-filtering.html">
     Filtering Signals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/beat-detection.html">
     Beat detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/signal-quality-assessment.html">
     Signal quality assessment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/pulse-arrival-time.html">
     Pulse Arrival Time
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/pulse-wave-analysis.html">
     Pulse Wave Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/notebooks/extracting-reference-bp.html">
     Extracting BP values
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../case-studies.html">
   Case Studies
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="bp-estimation-intro.html">
     Cuffless BP - Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bp-estimation-example.html">
     Cuffless BP - example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="vasc-age-intro.html">
     Vascular age - Intro
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Vascular age - example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../summary.html">
   Summary
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../closing/additional-resources.html">
     Additional Resources
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../about.html">
   About
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/about-contributing.html">
     Contributing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/about-maintenance.html">
     Maintenance
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../about/future-tutorials.html">
     Future Tutorials
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/notebooks/qrs-detection.html">
       QRS peak detection
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/data-modelling.html">
       Data modelling
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/data-analysis.html">
       Data analysis
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/data-interpretation.html">
       Data interpretation
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/acknowledgment.html">
     Acknowledgment
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/case-studies/vasc-age-example.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/peterhcharlton/bsp-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/peterhcharlton/bsp-book/issues/new?title=Issue%20on%20page%20%2Fcase-studies/vasc-age-example.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/peterhcharlton/bsp-book/edit/main/content/case-studies/vasc-age-example.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/peterhcharlton/bsp-book/main?urlpath=tree/content/case-studies/vasc-age-example.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/peterhcharlton/bsp-book/blob/main/content/case-studies/vasc-age-example.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Vascular age - example
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setup">
     Setup
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#import-libraries">
       Import libraries
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setup-database">
       Setup database
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#import-required-functions">
       Import required functions
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extracting-a-dataset">
   Extracting a dataset
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finding-suitable-records-in-the-database">
     Finding suitable records in the database
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-data-from-a-record">
     Extract data from a record
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#signal-processing">
   Signal processing
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-signals">
     Extract signals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#invert-ppg-signal">
     Invert PPG signal
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filter-signals">
     Filter signals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#beat-detection">
     Beat detection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ppg-beat-detection">
       PPG beat detection
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ecg-beat-detection">
       ECG beat detection
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-timings">
     Extract timings
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ecg-timings">
       ECG timings
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ppg-timings">
       PPG timings
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-pulse-arrival-times">
     Extract pulse arrival times
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#modelling">
   Modelling
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-dataset">
     Extract dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setup-1">
       Setup:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#extract-median-pulse-arrival-times">
       Extract median pulse arrival times
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#extract-ages">
       Extract ages
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inspect-dataset">
     Inspect dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#taking-it-further">
     Taking it further
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section id="vascular-age-example">
<h1>Vascular age - example<a class="headerlink" href="#vascular-age-example" title="Permalink to this headline">¶</a></h1>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<section id="import-libraries">
<h3>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The ‘WFDB’ toolbox provides tools for reading data from ‘WaveForm DataBase’ format (which is the format used on <a class="reference external" href="https://physionet.org/">PhysioNet</a>)</p></li>
<li><p>The ‘Neurokit2’ toolbox provides tools for physiological signal processing</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> pip install wfdb
<span class="o">!</span> pip install neurokit2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">neurokit2</span> <span class="k">as</span> <span class="nn">nk2</span>
<span class="kn">import</span> <span class="nn">wfdb</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Can you find out more about these packages? What is the 'Waveform DataBase Format', and what tasks could 'Neurokit' be used for? <br> <b>Hint:</b> See <a href="https://wfdb.readthedocs.io/">the WFDB documentation</a>, and the <a href="https://neuropsychology.github.io/NeuroKit/">the Neurokit documentation</a>.</p>
</div><ul class="simple">
<li><p>The following toolboxes are often used in data science, and provide tools for data analysis</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">median</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup-database">
<h3>Setup database<a class="headerlink" href="#setup-database" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Specify the name of the database on PhysioNet (<a class="reference external" href="https://physionet.org/content/pulse-transit-time-ppg/1.1.0/">here</a>).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">database_name</span> <span class="o">=</span> <span class="s1">&#39;pulse-transit-time-ppg/1.1.0&#39;</span> <span class="c1"># The name of the database on Physionet</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Do look into <a href="https://physionet.org/">PhysioNet</a> and the <a href="https://physionet.org/about/database/">datasets it hosts</a>.</p>
</div><ul class="simple">
<li><p>Find a list of records in the database</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">record_list</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">get_record_list</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>

<span class="c1"># Output the result</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">database_name</span><span class="si">}</span><span class="s2">&#39; database contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">record_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The &#39;pulse-transit-time-ppg/1.1.0&#39; database contains 66 records
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-required-functions">
<h3>Import required functions<a class="headerlink" href="#import-required-functions" title="Permalink to this headline">¶</a></h3>
<p>The following functions have been written to perform tasks specifically for this analysis.</p>
<p>It’s help to appreciate what the functions do (as described in the bullet points), and to be aware of the inputs to the functions (which are provided in the brackets on the first line of the function).</p>
<ul class="simple">
<li><p>This function finds suitable records in the database. It finds records which meet the following criteria:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">required_signals</span></code>: Contain the required signals</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_duration</span></code>: Are of at least the required duration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_activity</span></code>: Were collected during the required activity</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_suitable_records</span><span class="p">(</span><span class="n">required_signals</span><span class="p">,</span> <span class="n">required_duration</span><span class="p">,</span> <span class="n">required_activity</span><span class="p">,</span> <span class="n">do_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Finds suitable records in the Pulse Transit Time PPG dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="n">matching_recs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dir&#39;</span><span class="p">:[],</span> <span class="s1">&#39;name&#39;</span><span class="p">:[],</span> <span class="s1">&#39;length&#39;</span><span class="p">:[],</span> <span class="s1">&#39;start_sbp&#39;</span><span class="p">:[],</span> <span class="s1">&#39;end_sbp&#39;</span><span class="p">:[],</span> <span class="s1">&#39;delta_sbp&#39;</span><span class="p">:[],</span> <span class="s1">&#39;age&#39;</span><span class="p">:[]}</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">record_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Record: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="c1"># check whether this record corresponds to a suitable activity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required_activity</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   (not required activity)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">record_data</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="n">record</span><span class="p">,</span>
                                    <span class="n">pn_dir</span><span class="o">=</span><span class="n">database_name</span><span class="p">,</span>
                                    <span class="n">rd_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check whether the required signals are present in the record</span>
        <span class="n">sigs_present</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">sig_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">sigs_present</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">required_signals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   (missing signals)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">seg_length</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">sig_len</span><span class="o">/</span><span class="p">(</span><span class="n">record_data</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seg_length</span> <span class="o">&lt;</span> <span class="n">required_duration</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; (too short at </span><span class="si">{</span><span class="n">seg_length</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> mins)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
    
        <span class="c1"># This record does meet the requirements, so extract information and data from it</span>
    
        <span class="c1"># Information</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_data</span><span class="o">.</span><span class="n">record_name</span><span class="p">)</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_length</span><span class="p">)</span>
    
        <span class="c1"># Blood pressure measurements</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;bp_sys_start&gt;: &#39;</span>
        <span class="n">curr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span>
        <span class="n">start_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">+</span> <span class="n">curr_len</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;bp_sys_end&gt;&#39;</span>
        <span class="n">end_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;start_sbp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">start_el</span><span class="p">:</span><span class="n">end_el</span><span class="p">]))</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;bp_sys_end&gt;: &#39;</span>
        <span class="n">curr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span>
        <span class="n">start_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">+</span> <span class="n">curr_len</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;bp_dia_start&gt;&#39;</span>
        <span class="n">end_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;end_sbp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">start_el</span><span class="p">:</span><span class="n">end_el</span><span class="p">]))</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;delta_sbp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;end_sbp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;start_sbp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># ages</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;age&gt;: &#39;</span>
        <span class="n">curr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span>
        <span class="n">start_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">+</span> <span class="n">curr_len</span>
        <span class="n">str_to_find</span> <span class="o">=</span> <span class="s1">&#39;&lt;bp_sys_start&gt;&#39;</span>
        <span class="n">end_el</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_to_find</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">record_data</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">start_el</span><span class="p">:</span><span class="n">end_el</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   (met requirements)&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">record_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> records met the requirements.&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">matching_recs</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This function extracts a short segment of data from a longer record. It uses the following inputs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">start_seconds</span></code>: the start time at which to start extracting data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_seconds_to_load</span></code>: the duration of the segment to be extracted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">record_name</span></code>: the name of the record from which data are to be extracted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">record_dir</span></code>: the folder (a.k.a directory) which contains the record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_signals</span></code>: the signals to be extracted.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_segment_of_data</span><span class="p">(</span><span class="n">start_seconds</span><span class="p">,</span> <span class="n">n_seconds_to_load</span><span class="p">,</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_dir</span><span class="p">,</span> <span class="n">required_signals</span><span class="p">,</span> <span class="n">do_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Get sampling frequency from header data</span>
    <span class="n">record_data</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="n">record_name</span><span class="p">,</span>
                                <span class="n">pn_dir</span><span class="o">=</span><span class="n">record_dir</span><span class="p">,</span>
                                <span class="n">rd_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">record_data</span><span class="o">.</span><span class="n">fs</span>
    
    <span class="c1"># Specify timings of segment to be extracted</span>
    <span class="n">sampfrom</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">*</span> <span class="n">start_seconds</span>
    <span class="n">sampto</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_seconds</span> <span class="o">+</span> <span class="n">n_seconds_to_load</span><span class="p">)</span>

    <span class="c1"># Load segment data</span>
    <span class="n">segment_data</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdrecord</span><span class="p">(</span><span class="n">record_name</span><span class="o">=</span><span class="n">record_name</span><span class="p">,</span>
                                 <span class="n">channel_names</span> <span class="o">=</span> <span class="n">required_signals</span><span class="p">,</span>
                                 <span class="n">sampfrom</span><span class="o">=</span><span class="n">sampfrom</span><span class="p">,</span>
                                 <span class="n">sampto</span><span class="o">=</span><span class="n">sampto</span><span class="p">,</span>
                                 <span class="n">pn_dir</span><span class="o">=</span><span class="n">record_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_seconds_to_load</span><span class="si">}</span><span class="s2"> seconds of data extracted from record: </span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">segment_data</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This function finds peaks in PPG signal. It takes the following inputs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">raw</span></code>: raw PPG signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fs</span></code>: sampling frequency (in Hz)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ppg_peaks</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
  <span class="n">ppg_clean</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ppg_clean</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
  <span class="n">peaks</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ppg_findpeaks</span><span class="p">(</span><span class="n">ppg_clean</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;elgendi&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
  <span class="k">return</span> <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;PPG_Peaks&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This function finds peaks in an ECG signal. It takes the following inputs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">raw</span></code>: raw ECG signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fs</span></code>: sampling frequency (in Hz)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ecg_peaks</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="n">ecg_clean</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ecg_clean</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">signals</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ecg_peaks</span><span class="p">(</span><span class="n">ecg_clean</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;neurokit&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;ECG_R_Peaks&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">peaks</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This function finds PPG pulse onsets as the minimum values between each pair of identified PPG peaks. It takes the following inputs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ppg</span></code>: A PPG signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pks</span></code>: the peaks in a PPG signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fs</span></code>: the sampling frequency (in Hz)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ppg_onsets</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span> <span class="n">pks</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ibi</span> <span class="o">=</span> <span class="n">ppg</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">aux_ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">ibi</span><span class="p">)</span>
        <span class="c1"># aux_ons, = np.where(ibi == np.min(ibi))</span>
        <span class="n">ind_ons</span> <span class="o">=</span> <span class="n">aux_ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ons</span><span class="p">,</span> <span class="n">ind_ons</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>   

    <span class="n">ons</span> <span class="o">=</span> <span class="n">ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ons</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>A function to find the index in a list which immediately follows a specified point. It takes the following inputs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">array</span></code>: the list of sample numbers (e.g. a list of PPG peak sample numbers)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code>: the sample number of the specified point (e.g. an ECG R-wave sample number)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_next</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">array</span> <span class="o">-</span> <span class="n">value</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diffs</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">diffs</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">diffs</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="extracting-a-dataset">
<h1>Extracting a dataset<a class="headerlink" href="#extracting-a-dataset" title="Permalink to this headline">¶</a></h1>
<section id="finding-suitable-records-in-the-database">
<h2>Finding suitable records in the database<a class="headerlink" href="#finding-suitable-records-in-the-database" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Specify the required signals</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">name_of_ecg_signal</span> <span class="o">=</span> <span class="s2">&quot;ecg&quot;</span> <span class="c1"># the name of the ecg signal in the data</span>
<span class="n">name_of_ppg_signal</span> <span class="o">=</span> <span class="s2">&quot;pleth_1&quot;</span> <span class="c1"># the name of the ppg signal in the data</span>
<span class="n">required_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_of_ecg_signal</span><span class="p">,</span> <span class="n">name_of_ppg_signal</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Can you find out the details of the 'pleth_1' signal from the <a href="https://physionet.org/content/pulse-transit-time-ppg/1.1.0/">database description</a>? How was it measured? Is it ieal for vascular ageing assessment? What alternative signals are available?</p>
</div><ul class="simple">
<li><p>Specify the required duration in seconds</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">required_duration</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># in seconds</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Specify the required activity</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">required_activity</span> <span class="o">=</span> <span class="s2">&quot;sit&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Similarly, can you find out what different activities the data in this database were collected during? See the <a href="https://physionet.org/content/pulse-transit-time-ppg/1.1.0/">database description</a>.</p>
</div><ul class="simple">
<li><p>find records which meet these requirements</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">do_verbose</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># this tells the function to output some text to explain what it is doing.</span>
<span class="n">matching_recs</span> <span class="o">=</span> <span class="n">find_suitable_records</span><span class="p">(</span><span class="n">required_signals</span><span class="p">,</span> <span class="n">required_duration</span><span class="p">,</span> <span class="n">required_activity</span><span class="p">,</span> <span class="n">do_verbose</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Record: s1_walk   (not required activity)
Record: s1_run   (not required activity)
Record: s1_sit   (met requirements)
Record: s2_walk   (not required activity)
Record: s2_run   (not required activity)
Record: s2_sit   (met requirements)
Record: s3_sit   (met requirements)
Record: s3_walk   (not required activity)
Record: s3_run   (not required activity)
Record: s4_sit   (met requirements)
Record: s4_run   (not required activity)
Record: s4_walk   (not required activity)
Record: s5_walk   (not required activity)
Record: s5_run   (not required activity)
Record: s5_sit   (met requirements)
Record: s6_run   (not required activity)
Record: s6_sit   (met requirements)
Record: s6_walk   (not required activity)
Record: s7_walk   (not required activity)
Record: s7_run   (not required activity)
Record: s7_sit   (met requirements)
Record: s8_sit   (met requirements)
Record: s8_run   (not required activity)
Record: s8_walk   (not required activity)
Record: s9_walk   (not required activity)
Record: s9_sit   (met requirements)
Record: s9_run   (not required activity)
Record: s10_run   (not required activity)
Record: s10_walk   (not required activity)
Record: s10_sit   (met requirements)
Record: s11_sit   (met requirements)
Record: s11_walk   (not required activity)
Record: s11_run   (not required activity)
Record: s12_walk   (not required activity)
Record: s12_run   (not required activity)
Record: s12_sit   (met requirements)
Record: s13_walk   (not required activity)
Record: s13_sit   (met requirements)
Record: s13_run   (not required activity)
Record: s14_run   (not required activity)
Record: s14_walk   (not required activity)
Record: s14_sit   (met requirements)
Record: s15_walk   (not required activity)
Record: s15_sit   (met requirements)
Record: s15_run   (not required activity)
Record: s16_sit   (met requirements)
Record: s16_run   (not required activity)
Record: s16_walk   (not required activity)
Record: s17_run   (not required activity)
Record: s17_walk   (not required activity)
Record: s17_sit   (met requirements)
Record: s18_run   (not required activity)
Record: s18_walk   (not required activity)
Record: s18_sit   (met requirements)
Record: s19_walk   (not required activity)
Record: s19_sit   (met requirements)
Record: s19_run   (not required activity)
Record: s20_run   (not required activity)
Record: s20_walk   (not required activity)
Record: s20_sit   (met requirements)
Record: s21_walk   (not required activity)
Record: s21_sit   (met requirements)
Record: s21_run   (not required activity)
Record: s22_walk   (not required activity)
Record: s22_run   (not required activity)
Record: s22_sit   (met requirements)
A total of 22 out of 66 records met the requirements.
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-data-from-a-record">
<h2>Extract data from a record<a class="headerlink" href="#extract-data-from-a-record" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>specify details of the segment of data to be extracted</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_seconds</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">n_seconds_to_load</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">subj_no</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># In python, zero refers to the first item in a list</span>
<span class="n">record_name</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>
<span class="n">record_dir</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>extract this segment of data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">do_verbose</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">segment_data</span> <span class="o">=</span> <span class="n">extract_segment_of_data</span><span class="p">(</span><span class="n">start_seconds</span><span class="p">,</span> <span class="n">n_seconds_to_load</span><span class="p">,</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_dir</span><span class="p">,</span> <span class="n">required_signals</span><span class="p">,</span> <span class="n">do_verbose</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>60 seconds of data extracted from record: s1_sit
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="signal-processing">
<h1>Signal processing<a class="headerlink" href="#signal-processing" title="Permalink to this headline">¶</a></h1>
<section id="extract-signals">
<h2>Extract signals<a class="headerlink" href="#extract-signals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Extract PPG and ECG signals from the segment of data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sig_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ppg&quot;</span><span class="p">,</span> <span class="s2">&quot;ecg&quot;</span><span class="p">]</span> <span class="c1"># a list of signals to be extracted</span>
<span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">sig_list</span><span class="p">:</span>  <span class="c1"># cycle through each signal in the list</span>
    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;curr_sig_name = name_of_&quot;</span> <span class="o">+</span> <span class="n">sig</span> <span class="o">+</span> <span class="s2">&quot;_signal&quot;</span><span class="p">)</span>  <span class="c1"># specify the name of the signal</span>
    <span class="n">rel_col</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">sig_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">curr_sig_name</span><span class="p">)</span>  <span class="c1"># identify the column in the data which contains this signal</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">sig</span> <span class="o">+</span> <span class="s2">&quot; = segment_data.p_signal[:,rel_col]&quot;</span><span class="p">)</span>  <span class="c1"># extract the data for this signal</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Extract sampling frequency</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fs</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">fs</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="invert-ppg-signal">
<h2>Invert PPG signal<a class="headerlink" href="#invert-ppg-signal" title="Permalink to this headline">¶</a></h2>
<p>This is usually done to make the PPG signal look like a blood pressure signal. Consider why this is the case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ppg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">ppg</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="filter-signals">
<h2>Filter signals<a class="headerlink" href="#filter-signals" title="Permalink to this headline">¶</a></h2>
<p>Signals are filtered to eliminate noise from the signals, which makes it easier for the signal processing to perform well.</p>
<ul class="simple">
<li><p>Filter PPG</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ppg</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ppg_clean</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Info:</b> You can find out more about this function <a href="https://neuropsychology.github.io/NeuroKit/functions/ppg.html#neurokit2.ppg.ppg_clean">here</a>.</p>
</div><ul class="simple">
<li><p>Filter ECG</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ecg</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ecg_clean</span><span class="p">(</span><span class="n">ecg</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> You can find out more about this function <a href="https://neuropsychology.github.io/NeuroKit/functions/ecg.html#ecg-clean">here</a>. What frequency content does it exclude from the signal?</p>
</div></section>
<section id="beat-detection">
<h2>Beat detection<a class="headerlink" href="#beat-detection" title="Permalink to this headline">¶</a></h2>
<p>The next step is to detect beats in the signals</p>
<section id="ppg-beat-detection">
<h3>PPG beat detection<a class="headerlink" href="#ppg-beat-detection" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Detect beats</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ppg_peaks</span> <span class="o">=</span> <span class="n">get_ppg_peaks</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plot results</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># setup the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span>  <span class="c1"># plot the PPG signal</span>
<span class="n">heights</span> <span class="o">=</span> <span class="n">ppg</span><span class="p">[</span><span class="n">ppg_peaks</span><span class="p">]</span>  <span class="c1"># extract the heights of the PPG peaks</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ppg_peaks</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span> <span class="c1"># plot points indicating the PPG peaks (plot the sample numbers against the heights, using green circular markers)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/vasc-age-example_69_0.png" src="../_images/vasc-age-example_69_0.png" />
</div>
</div>
</section>
<section id="ecg-beat-detection">
<h3>ECG beat detection<a class="headerlink" href="#ecg-beat-detection" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Detect beats</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ecg_peaks</span> <span class="o">=</span> <span class="n">get_ecg_peaks</span><span class="p">(</span><span class="n">ecg</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plot results</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecg</span><span class="p">)</span>
<span class="n">heights</span> <span class="o">=</span> <span class="n">ecg</span><span class="p">[</span><span class="n">ecg_peaks</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ecg_peaks</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/vasc-age-example_74_0.png" src="../_images/vasc-age-example_74_0.png" />
</div>
</div>
</section>
</section>
<section id="extract-timings">
<h2>Extract timings<a class="headerlink" href="#extract-timings" title="Permalink to this headline">¶</a></h2>
<section id="ecg-timings">
<h3>ECG timings<a class="headerlink" href="#ecg-timings" title="Permalink to this headline">¶</a></h3>
<p>The ECG timings are simply the times of the R-waves, which indicate the times of ventricular depolarisation (i.e. the electrical activity which prompts ventricular contraction).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ecg_timings</span> <span class="o">=</span> <span class="n">ecg_peaks</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ppg-timings">
<h3>PPG timings<a class="headerlink" href="#ppg-timings" title="Permalink to this headline">¶</a></h3>
<p>Ideally, we wouldn’t use the times of systolic peaks on PPG waves, because there can be a variable delay between the pulse onset and systolic peak. Therefore, we use an alternative, such as the time of pulse onset:</p>
<ul class="simple">
<li><p>Getting the times of PPG pulse wave onsets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ppg_timings</span> <span class="o">=</span> <span class="n">get_ppg_onsets</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span><span class="n">ppg_peaks</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plotting the results</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span>
<span class="n">heights_peaks</span> <span class="o">=</span> <span class="n">ppg</span><span class="p">[</span><span class="n">ppg_peaks</span><span class="p">]</span>
<span class="n">heights_onsets</span> <span class="o">=</span> <span class="n">ppg</span><span class="p">[</span><span class="n">ppg_timings</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ppg_peaks</span><span class="p">,</span> <span class="n">heights_peaks</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ppg_timings</span><span class="p">,</span> <span class="n">heights_onsets</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/vasc-age-example_84_0.png" src="../_images/vasc-age-example_84_0.png" />
</div>
</div>
</section>
</section>
<section id="extract-pulse-arrival-times">
<h2>Extract pulse arrival times<a class="headerlink" href="#extract-pulse-arrival-times" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Find pairs of R-waves and subsequent PPG pulse onsets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rel_ppg_timings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ecg_timing</span> <span class="ow">in</span> <span class="n">ecg_timings</span><span class="p">:</span>
    <span class="n">current_ppg_timing</span> <span class="o">=</span> <span class="n">find_next</span><span class="p">(</span><span class="n">ppg_timings</span><span class="p">,</span> <span class="n">ecg_timing</span><span class="p">)</span>
    <span class="n">rel_ppg_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_ppg_timing</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Calculate pulse arrival times as the difference between the times of R-waves and subsequent PPG pulse onsets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pats</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_ppg_timings</span> <span class="o">-</span> <span class="n">ecg_timings</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modelling">
<h1>Modelling<a class="headerlink" href="#modelling" title="Permalink to this headline">¶</a></h1>
<section id="extract-dataset">
<h2>Extract dataset<a class="headerlink" href="#extract-dataset" title="Permalink to this headline">¶</a></h2>
<p>Extract a dataset of:</p>
<ul class="simple">
<li><p>Parameter(s) derived from PPG and ECG signals: pulse arrival time</p></li>
<li><p>Reference parameter(s): age</p></li>
</ul>
<div class="alert alert-block alert-info">
<p><b>Q:</b> What alternative reference parameters would be ideal?</p>
</div><section id="setup-1">
<h3>Setup:<a class="headerlink" href="#setup-1" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subj_nos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-median-pulse-arrival-times">
<h3>Extract median pulse arrival times<a class="headerlink" href="#extract-median-pulse-arrival-times" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">median_pats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">subj_no</span> <span class="ow">in</span> <span class="n">subj_nos</span><span class="p">:</span>

    <span class="c1"># specify this subject&#39;s record name and directory:</span>
    <span class="n">record_name</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>
    <span class="n">record_dir</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>

    <span class="c1"># extract this subject&#39;s signals</span>
    <span class="n">segment_data</span> <span class="o">=</span> <span class="n">extract_segment_of_data</span><span class="p">(</span><span class="n">start_seconds</span><span class="p">,</span> <span class="n">n_seconds_to_load</span><span class="p">,</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_dir</span><span class="p">,</span> <span class="n">required_signals</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">fs</span>
    <span class="n">sig_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ppg&quot;</span><span class="p">,</span> <span class="s2">&quot;ecg&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">sig_list</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;curr_sig_name = name_of_&quot;</span> <span class="o">+</span> <span class="n">sig</span> <span class="o">+</span> <span class="s2">&quot;_signal&quot;</span><span class="p">)</span>
        <span class="n">rel_col</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">sig_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">curr_sig_name</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">sig</span> <span class="o">+</span> <span class="s2">&quot; = segment_data.p_signal[:,rel_col]&quot;</span><span class="p">)</span>
        
    <span class="c1"># invert PPG signal</span>
    <span class="n">ppg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">ppg</span>
    
    <span class="c1"># filter signals</span>
    <span class="n">ppg</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ppg_clean</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ecg</span> <span class="o">=</span> <span class="n">nk2</span><span class="o">.</span><span class="n">ecg_clean</span><span class="p">(</span><span class="n">ecg</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    
    <span class="c1"># detect beats in signals</span>
    <span class="n">ecg_peaks</span> <span class="o">=</span> <span class="n">get_ecg_peaks</span><span class="p">(</span><span class="n">ecg</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">ppg_peaks</span> <span class="o">=</span> <span class="n">get_ppg_peaks</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
    
    <span class="c1"># obtain timings</span>
    <span class="n">ecg_timings</span> <span class="o">=</span> <span class="n">ecg_peaks</span>
    <span class="n">ppg_timings</span> <span class="o">=</span> <span class="n">get_ppg_onsets</span><span class="p">(</span><span class="n">ppg</span><span class="p">,</span><span class="n">ppg_peaks</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
    
    <span class="c1"># extract pulse arrival times</span>
    <span class="n">rel_ppg_timings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ecg_timing</span> <span class="ow">in</span> <span class="n">ecg_timings</span><span class="p">:</span>
        <span class="n">current_ppg_timing</span> <span class="o">=</span> <span class="n">find_next</span><span class="p">(</span><span class="n">ppg_timings</span><span class="p">,</span> <span class="n">ecg_timing</span><span class="p">)</span>
        <span class="n">rel_ppg_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_ppg_timing</span><span class="p">)</span>
    <span class="n">pats</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_ppg_timings</span> <span class="o">-</span> <span class="n">ecg_timings</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span>
    
    <span class="c1"># find median pulse arrival time for this subject</span>
    <span class="n">curr_median_pat</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">pats</span><span class="p">)</span>
    <span class="n">median_pats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_median_pat</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject no. </span><span class="si">{</span><span class="n">subj_no</span><span class="si">}</span><span class="s2"> has median PAT of </span><span class="si">{</span><span class="n">median_pats</span><span class="p">[</span><span class="n">subj_no</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Subject no. 0 has median PAT of 0.172 seconds
Subject no. 1 has median PAT of 0.658 seconds
Subject no. 2 has median PAT of 0.192 seconds
Subject no. 3 has median PAT of 0.162 seconds
Subject no. 4 has median PAT of 0.152 seconds
Subject no. 5 has median PAT of 0.192 seconds
Subject no. 6 has median PAT of 0.15 seconds
Subject no. 7 has median PAT of 0.154 seconds
Subject no. 8 has median PAT of 0.208 seconds
Subject no. 9 has median PAT of 0.18 seconds
Subject no. 10 has median PAT of 0.222 seconds
Subject no. 11 has median PAT of 0.176 seconds
Subject no. 12 has median PAT of 0.154 seconds
Subject no. 13 has median PAT of 0.168 seconds
Subject no. 14 has median PAT of 0.214 seconds
Subject no. 15 has median PAT of 0.184 seconds
Subject no. 16 has median PAT of 0.204 seconds
Subject no. 17 has median PAT of 0.18 seconds
Subject no. 18 has median PAT of 0.17 seconds
Subject no. 19 has median PAT of 0.184 seconds
Subject no. 20 has median PAT of 0.176 seconds
Subject no. 21 has median PAT of 0.158 seconds
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-ages">
<h3>Extract ages<a class="headerlink" href="#extract-ages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Cycle through each subject, extracting its age</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">subj_no</span> <span class="ow">in</span> <span class="n">subj_nos</span><span class="p">:</span>

    <span class="c1"># specify this subject&#39;s record name and directory:</span>
    <span class="n">record_name</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>
    <span class="n">record_dir</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>

    <span class="c1"># extract this subject&#39;s age</span>
    <span class="n">curr_age</span> <span class="o">=</span> <span class="n">matching_recs</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][</span><span class="n">subj_no</span><span class="p">]</span>
    <span class="n">ages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_age</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="inspect-dataset">
<h2>Inspect dataset<a class="headerlink" href="#inspect-dataset" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Plot the ages on the x-axis against median pulse arrival times on the y-axis</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">median_pats</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">median_pats</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pulse arrival time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/vasc-age-example_103_0.png" src="../_images/vasc-age-example_103_0.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Are there any outliers? Which point(s)?</p>
</div><ul class="simple">
<li><p>if we exclude the outlier:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rel_ages</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rel_median_pats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ages</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">median_pats</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.3</span><span class="p">:</span>
        <span class="n">rel_ages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ages</span><span class="p">[</span><span class="n">el</span><span class="p">])</span>
        <span class="n">rel_median_pats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_pats</span><span class="p">[</span><span class="n">el</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rel_ages</span><span class="p">,</span> <span class="n">rel_median_pats</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">rel_ages</span><span class="p">,</span> <span class="n">rel_median_pats</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rel_ages</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rel_ages</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pulse arrival time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/vasc-age-example_107_0.png" src="../_images/vasc-age-example_107_0.png" />
</div>
</div>
</section>
<section id="taking-it-further">
<h2>Taking it further<a class="headerlink" href="#taking-it-further" title="Permalink to this headline">¶</a></h2>
<div class="alert alert-block alert-info">
<p><b>Q:</b> Can you assess the strength of the correlation? <br> <b>Hint:</b> Consider using the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">'sklearn' package</a></p>
</div><div class="alert alert-block alert-info">
<p><b>Q:</b> What other parameters could we extract from the PPG signal? See the <a href="https://peterhcharlton.github.io/bsp-book/tutorials.html">tutorials</a> in this book, and also <a href="https://doi.org/10.1152/ajpheart.00392.2021">this article</a>.</p>
</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./case-studies"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="vasc-age-intro.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Vascular age - Intro</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../summary.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Summary</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By <a href="https://peterhcharlton.github.io/">Peter H Charlton</a> and the <a href="https://github.com/peterhcharlton/bsp-book#contributors-">Team</a>. Licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> license.<br/>
        
            &copy; Copyright 2023.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
    
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>


    
  </body>
</html>